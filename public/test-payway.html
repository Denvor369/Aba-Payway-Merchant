<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PayWay QR Sanity Test</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    label { display:block; margin: 8px 0 4px; }
    input { padding: 6px 8px; width: 200px; }
  </style>
</head>
<body>
  <h1>PayWay QR Sanity Test</h1>
  <p>This page bypasses your site code and calls your backend directly.</p>

  <label>Amount (USD)</label>
  <input id="amt" type="number" step="0.01" value="1.00" />

  <div style="margin-top:12px;">
    <button id="btn">Open PayWay</button>
  </div>

  <script>
    (function(){
      const API_BASE = "http://localhost:3000"; // change if you used another port

      function openPopup(contentHTML){
        const win = window.open("", "payway", "width=480,height=720");
        win.document.open(); win.document.write(contentHTML); win.document.close();
      }

      async function run() {
        const amount = Number(document.getElementById('amt').value || 1).toFixed(2);
        const win = window.open("", "payway", "width=480,height=720");
        try {
          const resp = await fetch(API_BASE + "/payway/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              amount: amount,
              currency: "USD",
              items: [{ name: "Test", qty: 1, price: amount }],
              firstname: "Tester",
              lastname: "User",
              email: "tester@example.com",
              phone: "+85500000000"
            })
          });
          const text = await resp.text();
          if (!resp.ok || !text) throw new Error("Bad response");

          if (text.trim().startsWith("<")) {
            win.document.open(); win.document.write(text); win.document.close();
            return;
          }
          const data = JSON.parse(text);
          if (data?.status?.code === "00") {
            win.document.open();
            win.document.write(`
              <html><head><meta name="viewport" content="width=device-width,initial-scale=1">
              <style>
                body{font-family:system-ui,Arial;margin:24px;text-align:center}
                img{max-width:260px}
                a.btn{display:inline-block;margin-top:12px;padding:10px 14px;border-radius:10px;border:1px solid #ccc;text-decoration:none}
                .note{color:#666;margin-top:10px;font-size:14px}
              </style></head><body>
                <h2>Scan with ABA Mobile</h2>
                <img src="${data.qrImage}" alt="ABA Pay QR"/>
                <div><a class="btn" href="${data.abapay_deeplink}">Open ABA App</a></div>
                <div class="note">Transaction ID: ${data.status.tran_id}</div>
              </body></html>
            `);
            win.document.close();
          } else {
            win.close();
            alert((data && (data.detail?.status?.message || data.error || JSON.stringify(data))) || "PayWay purchase failed");
          }
        } catch (e) {
          console.error(e);
          try { win.close(); } catch(_){}
          alert("Request failed. Is your server running on " + API_BASE + "?");
        }
      }

      document.getElementById('btn').addEventListener('click', run);
    })();
  </script>
</body>
</html>
